{% extends "base.html" %}
{% block content %}
<!-- Remove wrapper margins and make it blend with background -->
<div class="min-h-screen bg-slate-900 text-white">
    
    <!-- Chat Header - Remove separate container, integrate with chat window -->
    {% if chat_group.groupchat_name %}
    <div class="max-w-4xl mx-auto pt-6 px-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-white">{{ chat_group.groupchat_name }}</h2>
            {% if user == chat_group.admin %}
            <a href="#" 
               class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-700/50 hover:bg-indigo-600 transition">
                <svg class="w-4 h-4 fill-gray-300 group-hover:fill-white" viewBox="0 0 16 16">
                    <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Z"/>
                </svg>
                <span class="text-sm text-gray-200">Edit</span>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Single unified chat container - remove border and background -->
    <div class="max-w-4xl mx-auto px-4 pb-6">
        <div id="chat_window" class="h-[40rem] flex flex-col rounded-2xl overflow-hidden">
            
            <!-- Chat Top Bar - subtle background only -->
            <div class="flex items-center justify-between px-4 py-3 bg-slate-800/50 backdrop-blur-sm rounded-t-2xl border-b border-slate-700/50">
                {% if chat_group.is_private %}
                    {% if other_user %}
                    <div class="flex items-center gap-3">
                        <div id="online-icon" class="w-3 h-3 bg-green-400 rounded-full shadow-sm shadow-green-400/50"></div>
                        <a href="{% url "employees:employee_detail" other_user.pk %}" class="flex items-center gap-2 hover:text-blue-300 transition-colors">
                            <div>
                                <span class="font-semibold text-white">{{ other_user.first_name }}</span> 
                                <span class="text-xs text-gray-400">@{{ other_user.username }}</span>
                            </div>
                        </a>
                    </div>
                    {% endif %}
                {% elif chat_group.groupchat_name %}
                    <div class="flex items-center gap-4">
                            {% for member in chat_group.members.all %}
                            <li class="list-none">
                                <a href="{% url "employees:employee_detail" member.id %}"  
                                   class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-700/70 text-xs text-gray-200 hover:bg-indigo-500 hover:text-white transition-all duration-200">
                                   {{ member.first_name|first|upper }}{{ member.last_name|first|upper }}
                                </a>
                            </li>
                            {% endfor %}
                
                        <div class="flex items-center text-gray-300 text-sm">
                            <div id="online-icon" class="w-2 h-2 rounded-full bg-green-400 mr-2 shadow-sm shadow-green-400/50"></div>
                            <span id="online-count" class="font-medium"></span> online
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Messages - blend with background -->
            <div id="chat_container" class="flex-1 overflow-y-auto px-4 py-3 bg-slate-800/20">
                <ul id="chat_messages" class="flex flex-col gap-3">
                    {% for message in messages reversed %}
                        {% include 'chat/chat_message.html' %}
                    {% endfor %}
                </ul>
            </div>

            <!-- Input Bar - blend seamlessly -->
            <div class="px-4 py-4 bg-slate-800/50 backdrop-blur-sm rounded-b-2xl border-t border-slate-700/50">
                <div class="flex flex-col gap-3 w-full">
                    
                    <!-- Chat Message Form -->
                    <form id="chat_message_form"
                          class="relative w-full"
                          hx-ext="ws"
                          ws-connect="/ws/chatroom/{{ chat_group.group_name }}/"
                          ws-send
                          _="on htmx:wsAfterSend reset() me then focus() the first input in me">
                          
                          {% csrf_token %}
                          
                          <div class="relative">
                              {{ form.body }}
                              
                              <button type="submit"
                                      class="absolute right-3 top-1/2 transform -translate-y-1/2 
                                             w-10 h-10 rounded-full bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400
                                             text-white transition-all duration-200 shadow-lg hover:shadow-indigo-500/25
                                             flex items-center justify-center
                                             disabled:opacity-40 disabled:cursor-not-allowed"
                                      disabled
                                      _="on input from #id_body 
                                         if the target's value.trim() is not '' 
                                           remove @disabled from me 
                                         else 
                                           add @disabled to me">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                  </svg>
                              </button>
                          </div>
                    </form>

                    <!-- File Upload Form -->
                    <form id="chat_file_form" 
                          enctype="multipart/form-data"
                          class="flex items-center justify-between bg-slate-700/30 backdrop-blur-sm rounded-xl px-4 py-3 border border-slate-600/30"
                          hx-post="{% url 'chat:chat_file_upload' chat_group.group_name %}"
                          hx-target="#chat_messages"
                          hx-swap="beforeend"
                          _="on htmx:beforeSend reset() me">
                          
                          {% csrf_token %}
                          
                          <label for="id_file" 
                              class="cursor-pointer flex items-center gap-3 text-gray-300 hover:text-white transition-colors duration-200">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                              </svg>
                              <span class="text-sm font-medium">Choose File</span>
                          </label>
                          <input type="file" name="file" id="id_file" class="hidden">
                          
                          <button type="submit"
                              class="px-6 py-2 rounded-lg bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-medium transition-all duration-200 shadow-lg hover:shadow-emerald-500/25">
                              Upload
                          </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    function scrollToBottom(time=0) {
        setTimeout(function() {
            const container = document.getElementById('chat_container');
            container.scrollTop = container.scrollHeight;
        }, time);
    }
    scrollToBottom()
</script>
{% endblock %}

<!-- ADDITIONAL STYLE OVERRIDE FOR SEAMLESS BLENDING -->
<style>
    /* Make form inputs blend better */
    #id_body {
        background-color: rgba(51, 65, 85, 0.3) !important; /* slate-700 with transparency */
        border: 1px solid rgba(71, 85, 105, 0.5) !important; /* slate-600 with transparency */
        color: white !important;
    }
    
    #id_body:focus {
        background-color: rgba(51, 65, 85, 0.5) !important;
        border-color: rgba(99, 102, 241, 0.8) !important; /* indigo-500 */
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
    }
    
    /* Remove any default margins */
    .max-w-4xl {
        margin-left: auto;
        margin-right: auto;
    }
</style>